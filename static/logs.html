<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Container Logs</title>
	<link rel="stylesheet" href="picnic.min.css">
</head>
<body>
	<div>
		<button onclick="location.href='new.html'" type="button">Add New Instance</button>
    <button onclick="location.href='list.html'" type="button">Manage Instances</button>
	</div>
	<div>
		<select name="container" id="container">
		</select>
		<button onclick="connect()" id="connect">Connect</button>
		<button onclick="clearLog()">Clear</button>
		<button onclick="disconnect()" id="disconnect" disabled="">Disconnect</button>
	</div>
	<div style="font-family: monospace, monospace; font-size: small;" id="log"></div>
</body>
<script>

populate();

function populate(){
	var xhr = new XMLHttpRequest();

	xhr.onload = function() {
		const response = JSON.parse(xhr.responseText);

		var containers = response.containers;
		for (const container in containers) {
			var instanceName = containers[container].Names[0].substring(1);
			var option = document.createElement("option");
			option.setAttribute("value", instanceName);
			option.innerHTML = instanceName;
			document.getElementById("container").appendChild(option);
		}
	}

	xhr.open("GET", "/instance");
	xhr.setRequestHeader('Content-Type', 'application/json');
	xhr.send()
}

var ws = null;

function connect() {
	if (ws){
		disconnect();
	}
	var selected = document.getElementById("container");
	ws = new WebSocket(`ws://${location.host}` + "/" + selected.options[selected.selectedIndex].value);
	var log = document.getElementById('log');
	ws.onmessage = async function(data) {
		var line = await data.data.text();
		console.log(line);
		log.innerText = log.innerText + line;
	}
	document.getElementById('connect').setAttribute("disabled", "true");
	document.getElementById('disconnect').removeAttribute("disabled");
}

function disconnect() {
	if (ws) {
		ws.close();
		delete ws;
	}
	document.getElementById('connect').removeAttribute("disabled");
	document.getElementById('disconnect').setAttribute("disabled", "true");
}

function clearLog() {
	document.getElementById('log').innerHTML = "";
}
</script>
</html>